<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security6">
<head>
    <meta charset="UTF-8">
    <title th:text="${building.address}">Building Details</title>
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        .apt-gray { background-color: #f3f4f6; color: #9ca3af; border: 1px dashed #d1d5db; cursor: pointer; }
        .apt-gray:hover { background-color: #e5e7eb; }

        .apt-green { background-color: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; cursor: pointer; }
        .apt-red { background-color: #fef2f2; color: #dc2626; border: 1px solid #fecaca; cursor: pointer; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-content { background-color: #fff; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #000; }
        .form-row { margin-bottom: 1rem; }
        .form-row label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151; }
        .form-row select, .form-row input { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; }
    </style>
</head>
<body>

<div sec:authorize="hasRole('EMPLOYEE')">
    <nav th:replace="~{fragments/navbar :: navbar-fragment}"></nav>

    <main class="container">

        <div style="text-align: center; margin-bottom: 2rem;">
            <h1 th:text="${building.address}" style="margin-bottom: 0.5rem;">Building</h1>
            <p style="color: #6b7280;">Overview</p>
        </div>

        <div style="background-color: #eff6ff; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border: 1px solid #bfdbfe; color: #1e40af; display: flex; justify-content: space-around;">
            <div><strong>Rates:</strong></div>
            <div>Area: <span th:text="${building.company.defaultTaxPerSqM} + ' lv'"></span></div>
            <div>Elevator: <span th:text="${building.company.defaultElevatorTax} + ' lv'"></span></div>
            <div>Pet: <span th:text="${building.company.defaultPetTax} + ' lv'"></span></div>
        </div>

        <div class="finance-card">
            <div class="finance-row">
                <span class="finance-label">Cash (Collected)</span>
                <span class="finance-value text-green" th:text="${#numbers.formatDecimal(cashBalance, 1, 2)} + ' BGN'"></span>
            </div>
            <div class="finance-row">
                <span class="finance-label text-red">Liabilities</span>
                <span class="finance-value text-red" th:text="${#numbers.formatDecimal(totalLiabilities, 1, 2)} + ' BGN'"></span>
            </div>
        </div>

        <div class="content-card">
            <div th:each="entry : ${apartmentsByFloor}">
                <div class="floor-section">
                    <div class="floor-title">Floor <span th:text="${entry.key}"></span></div>
                    <div class="apartment-grid">
                        <div th:each="dto : ${entry.value}"
                             class="apt-card"
                             th:classappend="${dto.apartment.owner == null} ? 'apt-gray' : (${dto.hasDebt} ? 'apt-red' : 'apt-green')"
                             th:data-id="${dto.apartment.id}"
                             th:data-number="${dto.apartment.number}"
                             onclick="openModal(this.getAttribute('data-id'), this.getAttribute('data-number'))">

                            <span class="apt-number" th:text="${dto.apartment.number}">B01</span>

                            <small th:if="${dto.apartment.owner != null}" style="font-weight: 500; font-size: 0.75rem; margin-top: 0.25rem;">
                                <span th:text="${#numbers.formatDecimal(dto.monthlyFee, 1, 'WHITESPACE', 2, 'POINT')}">50.00</span> lv
                            </small>

                            <small th:if="${dto.apartment.owner == null}" style="font-size: 0.75rem; margin-top: 0.25rem;">Empty</small>

                            <small th:if="${dto.apartment.hasPet}" style="font-size: 0.65rem; color: #6b7280; display: block;">
                                <i class="fas fa-paw"></i> Pet
                            </small>

                        </div>
                    </div>
                    <hr style="border-top: 1px solid #f3f4f6; margin-top: 1.5rem;">
                </div>
            </div>
        </div>

    </main>

    <div id="configModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Configure Apartment</h2>

            <form th:action="@{/employee/buildings/configure-apartment}" method="post">
                <input type="hidden" id="modalAptId" name="apartmentId" />

                <div class="form-row">
                    <label>Assign Owner Account (Payer)</label>
                    <select name="ownerId" required>
                        <option value="" disabled selected>Select User account...</option>
                        <option th:each="u : ${allUsers}"
                                th:value="${u.id}"
                                th:text="${u.username} + ' (' + ${u.email} + ')'"></option>
                    </select>
                    <small style="color: #6b7280;">This user will see the bill in their app.</small>
                </div>

                <div class="form-row" style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="checkbox" id="hasPet" name="hasPet" style="width: auto;">
                    <label for="hasPet" style="margin: 0;">Has Pet?</label>
                </div>

                <hr style="margin: 1rem 0; border: 0; border-top: 1px solid #eee;">

                <div class="form-row">
                    <label>Residents (For Tax Calculation)</label>
                    <input type="number" id="residentsCount" min="0" max="10" placeholder="0" oninput="generateResidentSelects()">
                    <small style="color: #888;">How many people live here? (Select them below)</small>
                </div>

                <div id="dynamicResidentsContainer"></div>

                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Save Configuration</button>
            </form>
        </div>
    </div>

    <select id="hiddenResidentsList" style="display:none;">
        <option th:each="res : ${allResidents}"
                th:value="${res.id}"
                th:text="${res.name} + ' (Age: ' + ${res.age} + ')'"></option>
    </select>

    <script>
        function openModal(aptId, aptNumber) {
            document.getElementById("configModal").style.display = "block";
            document.getElementById("modalAptId").value = aptId;
            document.getElementById("modalTitle").innerText = "Configure Apt " + aptNumber;
        }

        function closeModal() {
            document.getElementById("configModal").style.display = "none";
        }

        function generateResidentSelects() {
            const count = document.getElementById('residentsCount').value;
            const container = document.getElementById('dynamicResidentsContainer');
            const optionsHTML = document.getElementById('hiddenResidentsList').innerHTML;

            container.innerHTML = '';

            for (let i = 1; i <= count; i++) {
                const div = document.createElement('div');
                div.className = 'form-row';
                div.style.marginTop = '10px';

                const label = document.createElement('label');
                label.innerText = 'Resident #' + i;
                label.style.fontSize = '0.9em';

                const select = document.createElement('select');
                select.name = 'residentIds';
                select.required = true;
                select.innerHTML = '<option value="" disabled selected>Select person...</option>' + optionsHTML;

                div.appendChild(label);
                div.appendChild(select);
                container.appendChild(div);
            }
        }

        window.onclick = function(event) {
            if (event.target === document.getElementById("configModal")) {
                closeModal();
            }
        }
    </script>

</div>
</body>
</html>